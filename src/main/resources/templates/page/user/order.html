<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Đơn hàng của tôi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/index_style.css}">

    <style>
        .timeline {
            padding: 20px 0;
        }

        .timeline-items {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .timeline-items::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .timeline-item {
            position: relative;
            z-index: 2;
            background: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e0e0e0;
        }

        .timeline-item.active {
            border-color: #28a745;
            color: #28a745;
        }

        .timeline-item::after {
            content: attr(data-title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <th:block th:replace="~{index :: header}"></th:block>

    <div class="container py-5">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div th:replace="~{fragments/user_sidebar :: sidebar('orders')}"></div>
            </div>

            <!-- Main content -->
            <div class="col-md-9">
                <h2 class="mb-4">Đơn hàng của tôi</h2>

                <!-- Tabs cho các trạng thái đơn hàng -->
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#all">Tất cả</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#pending">Đã đặt đơn</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#confirmed">Đã thanh toán</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#preparing">Đang chuẩn bị</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#shipping">Đang giao hàng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#delivered">Đã giao hàng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#cancelled">Đã hủy</a>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content">
                    <!-- Tất cả đơn hàng -->
                    <div class="tab-pane fade show active" id="all">
                        <div th:each="order : ${orders}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>

                            <!-- Thêm timeline trạng thái đơn hàng -->
                            <div class="card-footer">
                                <div class="timeline">
                                    <div class="timeline-items">
                                        <div th:class="'timeline-item' + (${order.status == 'PENDING' || order.status == 'CONFIRMED' || order.status == 'PREPARING' || order.status == 'SHIPPING' || order.status == 'DELIVERED'} ? ' active' : '')"
                                            data-title="Đã đặt đơn">
                                            <i class="fas fa-shopping-cart"></i>
                                        </div>
                                        <div th:class="'timeline-item' + (${order.status == 'CONFIRMED' || order.status == 'PREPARING' || order.status == 'SHIPPING' || order.status == 'DELIVERED'} ? ' active' : '')"
                                            data-title="Đã thanh toán">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <div th:class="'timeline-item' + (${order.status == 'PREPARING' || order.status == 'SHIPPING' || order.status == 'DELIVERED'} ? ' active' : '')"
                                            data-title="Đang chuẩn bị">
                                            <i class="fas fa-box"></i>
                                        </div>
                                        <div th:class="'timeline-item' + (${order.status == 'SHIPPING' || order.status == 'DELIVERED'} ? ' active' : '')"
                                            data-title="Đang giao hàng">
                                            <i class="fas fa-truck"></i>
                                        </div>
                                        <div th:class="'timeline-item' + (${order.status == 'DELIVERED'} ? ' active' : '')"
                                            data-title="Đã giao hàng">
                                            <i class="fas fa-home"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab cho từng trạng thái -->
                    <div class="tab-pane fade" id="pending">
                        <div th:each="order : ${orders}" th:if="${order.status == 'PENDING'}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="confirmed">
                        <div th:each="order : ${orders}" th:if="${order.status == 'CONFIRMED'}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="preparing">
                        <div th:each="order : ${orders}" th:if="${order.status == 'PREPARING'}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="shipping">
                        <div th:each="order : ${orders}" th:if="${order.status == 'SHIPPING'}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="delivered">
                        <div th:each="order : ${orders}" th:if="${order.status == 'DELIVERED'}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="cancelled">
                        <div th:each="order : ${orders}" th:if="${order.status == 'CANCELLED'}" class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Đơn hàng #[[${order.id}]]</span>
                                <span class="badge" th:classappend="${
                                    order.status == 'PENDING' ? 'bg-warning' :
                                    order.status == 'CONFIRMED' ? 'bg-info' :
                                    order.status == 'SHIPPING' ? 'bg-primary' :
                                    order.status == 'DELIVERED' ? 'bg-success' :
                                    order.status == 'CANCELLED' ? 'bg-danger' : 'bg-secondary'
                                }" th:text="${order.status}">Status</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Sản phẩm</th>
                                                <th>Số lượng</th>
                                                <th class="text-end">Giá</th>
                                                <th class="text-end">Tổng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="item : ${order.orderItems}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img th:src="${item.book.cover}" alt="Book Cover"
                                                            style="width: 50px; height: 70px; object-fit: cover;"
                                                            class="me-3">
                                                        <div>
                                                            <h6 class="mb-0" th:text="${item.book.title}"></h6>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td th:text="${item.quantity}"></td>
                                                <td class="text-end" th:text="${item.price} + ' VNĐ'"></td>
                                                <td class="text-end" th:text="${item.price * item.quantity} + ' VNĐ'">
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" class="text-end fw-bold">Tổng cộng:</td>
                                                <td class="text-end fw-bold" th:text="${order.total} + ' VNĐ'"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Thông tin giao hàng -->
                                <div class="mt-3">
                                    <p><strong>Địa chỉ giao hàng:</strong>
                                        <span th:text="${order.orderAddress}"></span>
                                    </p>
                                    <p><strong>Phương thức thanh toán:</strong>
                                        <span th:if="${not #lists.isEmpty(order.payments)}"
                                            th:with="payment=${order.payments[0]}">
                                            <span th:text="${
                                                payment.provider == 'COD' ? 'Thanh toán khi nhận hàng' : 
                                                payment.provider == 'VNPAY' ? 'Thanh toán VNPAY' :
                                                payment.provider == 'MOMO' ? 'Ví MoMo' :
                                                payment.provider == 'VISA' ? 'Thẻ Visa/Master' :
                                                payment.provider == 'BANKING' ? 'Chuyển khoản ngân hàng' :
                                                payment.provider}">
                                            </span>
                                            <!-- Chỉ hiển thị trạng thái thanh toán khi đơn hàng không bị hủy -->
                                            <span th:if="${order.status != 'CANCELLED'}" th:text="'(' + ${payment.status == 'PENDING' ? 'Chờ thanh toán' :
                                                                  payment.status == 'SUCCESS' ? 'Đã thanh toán' :
                                                                  payment.status == 'FAILED' ? 'Thanh toán thất bại' :
                                                                  payment.status} + ')'">
                                            </span>
                                            <!-- Chỉ hiện nút thanh toán khi đơn hàng PENDING và phương thức không phải COD -->
                                            <button
                                                th:if="${order.status == 'PENDING' && payment.status == 'PENDING' && payment.provider != 'COD'}"
                                                class="btn btn-primary btn-sm ms-2"
                                                th:onclick="'processPayment(' + ${order.id} + ')'">
                                                Thanh toán ngay
                                            </button>
                                        </span>
                                    </p>
                                    <p><strong>Ngày đặt hàng:</strong>
                                        <span th:text="${#dates.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                    </p>
                                </div>

                                <!-- Nút hủy đơn hàng - Cho phép hủy khi status là PENDING hoặc CONFIRMED -->
                                <div class="mt-3" th:if="${order.status == 'PENDING' || order.status == 'CONFIRMED'}">
                                    <button class="btn btn-outline-danger"
                                        th:onclick="'cancelOrder(' + ${order.id} + ')'">
                                        Hủy đơn hàng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{index :: footer}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script>
        function cancelOrder(orderId) {
            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
                fetch(`/user/order/${orderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert('Không thể hủy đơn hàng này');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Đã xảy ra lỗi khi hủy đơn hàng');
                    });
            }
        }
    </script>

    <!-- Thêm script xử lý thanh toán -->
    <script th:inline="javascript">
        function processPayment(orderId) {
            if (confirm('Xác nhận thanh toán đơn hàng này?')) {
                fetch(`/user/order/${orderId}/pay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            throw new Error('Thanh toán thất bại');
                        }
                    })
                    .catch(error => {
                        alert(error.message);
                    });
            }
        }
    </script>
    <script th:src="@{/js/cart.js}"></script>
    <script th:src="@{/js/wishlist.js}"></script>
    <script th:src="@{/js/search_book.js}"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>

</body>

</html>